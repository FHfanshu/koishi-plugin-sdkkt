# 群文件图片处理功能

## 功能概述

此插件已增强支持处理群文件中的图片。当用户在群聊中上传图片文件时，插件可以自动检测并解析其中的 Stable Diffusion 元数据。

## 功能特点

### 1. 自动检测群文件图片
- 监听群文件上传事件
- 自动识别图片文件格式（支持 JPG、PNG、WebP、GIF、BMP、TIFF、HEIC、HEIF）
- 非图片文件自动跳过处理

### 2. 文件大小限制
- 仅处理 10MB 以下的图片文件
- 大于 10MB 的文件自动跳过，避免内存占用和下载超时

### 3. 智能下载机制
- 通过 OneBot 协议的 `get_group_file_url` 接口获取下载链接
- 支持多种 OneBot 实现（LLOneBot、go-cqhttp、Lagrange 等）
- 自动处理下载失败情况

### 4. 白名单控制
- 仅在配置的群聊白名单中启用自动解析
- 需要设置 `groupAutoParseWhitelist` 配置项

## 配置说明

在 Koishi 配置文件中添加以下配置：

```json
{
  "plugins": {
    "sdexif": {
      "useForward": false,
      "enableDebugLog": true,
      "privateOnly": false,
      "groupAutoParseWhitelist": ["123456", "789012"]  // 启用自动解析的群号
    }
  }
}
```

## 工作原理

### 1. 事件监听
插件通过两种方式处理群文件：
- **主动检测**：在 `collectImageSegments` 函数中检测会话事件中的文件信息
- **被动处理**：当用户发送 `/sdexif` 或 `/读图` 命令时处理群文件

### 2. 文件识别流程
```
群文件事件 → 文件大小检查(≤10MB) → 文件类型检查(图片格式) → 下载 → 解析元数据 → 发送结果
```

### 3. 下载流程
```
获取文件信息 → 调用 getGroupFileUrl → 获取下载链接 → HTTP下载 → 解析图片
```

## 支持的图片格式

- **位图格式**：JPG/JPEG、PNG、GIF、BMP
- **现代格式**：WebP、TIFF、HEIC、HEIF
- **大小限制**：≤ 10MB

## 错误处理

插件具备完善的错误处理机制：
- 文件过大：记录日志并跳过
- 非图片文件：记录日志并跳过
- 下载失败：记录警告日志
- 解析失败：记录错误日志
- 无元数据：静默处理，不发送消息

## 性能优化

- **内存管理**：大文件自动跳过，避免内存溢出
- **超时控制**：下载超时设置为30秒
- **并发控制**：单文件顺序处理，避免并发下载
- **缓存机制**：临时文件自动清理

## 调试信息

启用 `enableDebugLog: true` 后，插件会输出详细的调试信息：
- 检测到群文件事件
- 文件大小和类型检查
- 下载链接获取过程
- 下载和解析状态
- 最终结果发送

## 使用示例

### 场景1：自动解析
用户在白名单群聊上传 `example.png` → 插件自动检测 → 解析元数据 → 发送结果

### 场景2：命令触发
用户在群聊上传图片后发送 `/读图` → 插件处理 → 发送解析结果

### 场景3：大小限制
用户上传 15MB 的 PSD 文件 → 插件检测到文件过大 → 跳过处理

## 注意事项

1. **权限要求**：机器人需要有获取群文件下载链接的权限
2. **网络要求**：需要能够访问文件下载链接
3. **格式支持**：仅支持常见的图片格式，不支持文档、视频等
4. **OneBot兼容性**：依赖 OneBot 协议的 `get_group_file_url` 接口

## 故障排除

### 无法获取下载链接
- 检查机器人权限
- 确认 OneBot 实现支持 `get_group_file_url`
- 查看调试日志获取详细信息

### 下载失败
- 检查网络连接
- 确认文件链接有效性
- 查看是否有防火墙限制

### 无元数据输出
- 确认图片是否包含 SD 元数据
- 检查图片是否为 AI 生成
- 尝试手动提取验证元数据存在